name: Build Windows EXE

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to build'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
      upload_release:
        description: 'Upload to GitHub Release'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests for faster build'
        required: false
        default: false
        type: boolean

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: write          # ç”¨äºåˆ›å»ºreleaseå’Œä¸Šä¼ artifact
  actions: read            # ç”¨äºè¯»å–actionsçŠ¶æ€
  security-events: write   # ç”¨äºå®‰å…¨æ‰«ææŠ¥å‘Š
  pages: write            # ç”¨äºéƒ¨ç½²é¡µé¢ï¼ˆå¯é€‰ï¼‰
  pull-requests: write     # ç”¨äºPRç›¸å…³æ“ä½œ

env:
  # å…¨å±€ç¯å¢ƒå˜é‡
  PYTHONIOENCODING: utf-8
  PYTHONUNBUFFERED: 1
  # æ„å»ºé…ç½®
  BUILD_TIMESTAMP: ${{ github.run_number }}-${{ github.sha }}
  APP_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || '1.0.0' }}
  # ç¼“å­˜é”®å‰ç¼€
  CACHE_VERSION: v2

jobs:
  # é¢„æ„å»ºæ£€æŸ¥å’ŒçŸ©é˜µç”Ÿæˆ
  pre-build:
    name: Pre-build Validation
    runs-on: windows-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_publish: ${{ steps.check-publish.outputs.should_publish }}
      version_tag: ${{ steps.version.outputs.version_tag }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate build matrix
        id: set-matrix
        run: |
          $matrix = @{
            "python-version" = @("3.9", "3.10", "3.11")
            "platform" = @("windows-latest")
          }

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†Pythonç‰ˆæœ¬ï¼Œåˆ™ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
          if ('${{ github.event.inputs.python_version }}') {
            $matrix["python-version"] = @('${{ github.event.inputs.python_version }}')
          }

          $matrixJson = $matrix | ConvertTo-Json -Compress
          echo "matrix=$matrixJson" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Build matrix: $matrixJson"

      - name: Determine publish strategy
        id: check-publish
        run: |
          $shouldPublish = $false
          if ('${{ github.ref_type }}' -eq 'tag') {
            $shouldPublish = $true
          } elseif ('${{ github.event_name }}' -eq 'workflow_dispatch' -and '${{ github.event.inputs.upload_release }}' -eq 'true') {
            $shouldPublish = $true
          } elseif ('${{ github.ref }}' -eq 'refs/heads/main') {
            $shouldPublish = $true
          }

          echo "should_publish=$shouldPublish" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Should publish: $shouldPublish"

      - name: Generate version information
        id: version
        run: |
          $versionTag = "${{ env.APP_VERSION }}"
          $buildNumber = "${{ github.run_number }}"

          if ('${{ github.ref_type }}' -ne 'tag') {
            $versionTag = "dev-$buildNumber-${{ github.sha }}"
          }

          echo "version_tag=$versionTag" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "build_number=$buildNumber" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Version tag: $versionTag"

  # ä¸»è¦æ„å»ºä»»åŠ¡
  build:
    name: Build Python ${{ matrix.python-version }}
    needs: pre-build
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.pre-build.outputs.matrix) }}

    outputs:
      artifact_name: ${{ steps.artifact.outputs.artifact_name }}
      exe_path: ${{ steps.artifact.outputs.exe_path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ç¯å¢ƒåˆå§‹åŒ–
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            setup.py

      - name: Set up Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v1.3
        continue-on-error: true
        timeout-minutes: 10

      - name: Configure environment variables
        run: |
          echo "PYTHONPATH=$PWD" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "DIST_DIR=dist" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "BUILD_ARTIFACTS=build-artifacts" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "ARTIFACT_NAME=ww-toolbox-${{ needs.pre-build.outputs.version_tag }}-py${{ matrix.python-version }}-win64" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      # ä¾èµ–ç®¡ç†å’Œç¼“å­˜ä¼˜åŒ–
      - name: Cache pip dependencies
        uses: actions/cache@v4
        id: cache-pip
        with:
          path: |
            ~/.cache/pip
            ~/AppData/Local/pip
          key: ${{ env.CACHE_VERSION }}-pip-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-pip-${{ runner.os }}-py${{ matrix.python-version }}-
            ${{ env.CACHE_VERSION }}-pip-${{ runner.os }}-

      - name: Cache prebuilt wheels
        uses: actions/cache@v4
        id: cache-wheels
        with:
          path: |
            ~/.local/share/renv
            ~/AppData/Local/pip/cache
          key: ${{ env.CACHE_VERSION }}-wheels-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-wheels-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          # å‡çº§pipå’Œå®‰è£…æ„å»ºå·¥å…·
          python -m pip install --upgrade pip setuptools wheel

          # å°è¯•å®‰è£…pybind11
          try {
            pip install pybind11
            Write-Host "pybind11 installed successfully" -ForegroundColor Green
          } catch {
            Write-Host "Warning: pybind11 installation failed, will skip C++ extensions" -ForegroundColor Yellow
          }

          # å°è¯•å®‰è£…pywin32ï¼ˆå…³é”®ä¾èµ–ï¼Œå¤šæ¬¡å°è¯•ï¼‰
          $pywin32Installed = $false
          for ($i = 1; $i -le 3; $i++) {
            Write-Host "Attempt $i to install pywin32..." -ForegroundColor Cyan
            try {
              pip install pywin32 --no-cache-dir
              if ($LASTEXITCODE -eq 0) {
                $pywin32Installed = $true
                Write-Host "pywin32 installed successfully" -ForegroundColor Green
                break
              }
            } catch {
              Write-Host "Attempt $i failed" -ForegroundColor Yellow
            }

            Start-Sleep -Seconds 2
          }

          if (-not $pywin32Installed) {
            Write-Host "Warning: pywin32 installation failed after 3 attempts, trying alternatives..." -ForegroundColor Yellow
            try {
              pip install pywin32-ctypes
              Write-Host "pywin32-ctypes installed as fallback" -ForegroundColor Green
            } catch {
              Write-Host "Warning: All pywin32 installation attempts failed" -ForegroundColor Red
            }
          }

      - name: Install Python dependencies
        run: |
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
          pip install virtualenv
          virtualenv venv
          venv\Scripts\activate

          # å‡çº§pipå’Œç›¸å…³å·¥å…·
          python -m pip install --upgrade pip setuptools wheel

          # å…ˆå®‰è£…å…³é”®ä¾èµ–ï¼ˆä½¿ç”¨æ›´ç¨³å®šçš„å®‰è£…æ–¹å¼ï¼‰
          pip install pybind11

          # å®‰è£…pywin32å¹¶éªŒè¯
          Write-Host "Installing pywin32..." -ForegroundColor Cyan
          pip install pywin32
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Failed to install pywin32, trying alternative method..." -ForegroundColor Yellow
            pip install pywin32 --no-deps
            pip install pywin32-ctypes
          }

          # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆé€ä¸ªå®‰è£…å…³é”®ä¾èµ–ä»¥æé«˜æˆåŠŸç‡ï¼‰
          Write-Host "Installing critical dependencies..." -ForegroundColor Cyan
          pip install fastapi uvicorn aiohttp requests beautifulsoup4 numpy pillow tqdm setuptools

          # å®‰è£…AIç›¸å…³ä¾èµ–
          Write-Host "Installing AI/ML dependencies..." -ForegroundColor Cyan
          pip install rapidocr openvino onnxruntime

          # å®‰è£…å…¶ä»–ä¾èµ–
          Write-Host "Installing remaining dependencies..." -ForegroundColor Cyan
          pip install keyboard

          # å°è¯•å®‰è£…é¡¹ç›®ï¼ˆå¦‚æœå¤±è´¥åˆ™è·³è¿‡C++æ‰©å±•ï¼‰
          try {
            pip install -e .
            Write-Host "Project installed with C++ extensions" -ForegroundColor Green
          } catch {
            Write-Host "Warning: Failed to install project with C++ extensions, installing without..." -ForegroundColor Yellow
            pip install -e . --no-build-isolation || pip install -e . --no-deps --no-build-isolation
            Write-Host "Project installed without C++ extensions" -ForegroundColor Yellow
          }

          # å®‰è£…æ„å»ºå’Œæµ‹è¯•å·¥å…·
          pip install flake8 black mypy pytest pytest-cov bandit safety

          # éªŒè¯å…³é”®ä¾èµ–ï¼ˆä¿®å¤ç‰ˆæœ¬æ£€æŸ¥é—®é¢˜ï¼‰
          Write-Host "Verifying critical dependencies..." -ForegroundColor Cyan

          # éªŒè¯rapidocr
          try {
            python -c "import rapidocr; print('RapidOCR version:', rapidocr.__version__ if hasattr(rapidocr, '__version__') else 'unknown')"
          } catch {
            try {
              python -c "import rapidocr; print('RapidOCR imported successfully')"
            } catch {
              Write-Host "Warning: RapidOCR import failed, but continuing..." -ForegroundColor Yellow
            }
          }

          # éªŒè¯openvino
          try {
            python -c "import openvino; print('OpenVINO version:', openvino.__version__)"
          } catch {
            Write-Host "Warning: OpenVINO import failed, but continuing..." -ForegroundColor Yellow
          }

          # éªŒè¯pywin32ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•éªŒè¯ï¼‰
          try {
            python -c "import pywin32; print('pywin32 imported successfully')"
          } catch {
            try {
              python -c "import win32gui; print('win32gui imported successfully')"
            } catch {
              try {
                python -c "import win32api; print('win32api imported successfully')"
              } catch {
                try {
                  python -c "import win32con; print('win32con imported successfully')"
                } catch {
                  Write-Host "Warning: pywin32 modules not available, but continuing..." -ForegroundColor Yellow
                }
              }
            }
          }

          # éªŒè¯é¡¹ç›®æ ¸å¿ƒæ¨¡å—
          try {
            python -c "import toolbox.core.api; print('Toolbox core API imported successfully')"
          } catch {
            Write-Host "Warning: Toolbox core API import failed, but continuing..." -ForegroundColor Yellow
          }

          # æ£€æŸ¥C++æ‰©å±•å¯ç”¨æ€§
          try {
            python -c "import toolbox.core.profile_cpp; print('C++ profile module available')"
          } catch {
            Write-Host "Info: C++ profile module not available (using Python fallback)" -ForegroundColor Cyan
          }

      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: Run code quality checks
        run: |
          venv\Scripts\activate

          # Flake8 ä»£ç é£æ ¼æ£€æŸ¥
          Write-Host "Running Flake8..." -ForegroundColor Green
          flake8 toolbox/ --max-line-length=88 --ignore=E203,W503 --format=github

          # Black ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
          Write-Host "Checking Black formatting..." -ForegroundColor Green
          black --check --diff toolbox/ || echo "Black formatting check completed with issues"

          # MyPy ç±»å‹æ£€æŸ¥
          Write-Host "Running MyPy type checking..." -ForegroundColor Green
          mypy toolbox/core/ --ignore-missing-imports --warn-return-any --warn-unused-configs || echo "MyPy completed with issues"

      - name: Security vulnerability scan
        run: |
          venv\Scripts\activate

          # Bandit å®‰å…¨æ‰«æ
          Write-Host "Running Bandit security scan..." -ForegroundColor Green
          bandit -r toolbox/ -f json -o bandit-report.json || echo "Bandit completed with findings"

          # Safety ä¾èµ–å®‰å…¨æ£€æŸ¥
          Write-Host "Running Safety dependency check..." -ForegroundColor Green
          safety check --json --output safety-report.json || echo "Safety completed with findings"

      # å•å…ƒæµ‹è¯•æ‰§è¡Œ
      - name: Run unit tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          venv\Scripts\activate

          # åˆ›å»ºæµ‹è¯•ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if (-not (Test-Path "tests")) {
            New-Item -ItemType Directory -Force -Path "tests"
            # åˆ›å»ºåŸºæœ¬æµ‹è¯•æ–‡ä»¶
            @"
          import pytest
          from toolbox.core.profile import EchoProfile

          def test_echo_profile_creation():
              """æµ‹è¯•EchoProfileåˆ›å»º"""
              profile = EchoProfile(level=0)
              assert profile.level == 0

          def test_imports():
              """æµ‹è¯•å…³é”®æ¨¡å—å¯¼å…¥"""
              import rapidocr
              import openvino
              # éªŒè¯æ¨¡å—èƒ½å¤ŸæˆåŠŸå¯¼å…¥ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„æ£€æŸ¥ï¼‰
              assert hasattr(rapidocr, 'RapidOCR') or hasattr(rapidocr, 'RapidOcr')
              assert hasattr(openvino, '__version__')

          def test_pywin32_imports():
              """æµ‹è¯•Windows APIæ¨¡å—å¯¼å…¥"""
              # å°è¯•å¯¼å…¥å„ç§pywin32å­æ¨¡å—
              pywin32_available = False
              try:
                  import win32gui
                  pywin32_available = True
              except ImportError:
                  pass

              try:
                  import win32api
                  pywin32_available = True
              except ImportError:
                  pass

              try:
                  import win32con
                  pywin32_available = True
              except ImportError:
                  pass

              # è‡³å°‘æœ‰ä¸€ä¸ªpywin32æ¨¡å—å¯ç”¨å°±é€šè¿‡æµ‹è¯•
              assert pywin32_available, "No pywin32 modules available"
          "@ | Out-File -FilePath "tests/test_basic.py" -Encoding utf8
          }

          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          pytest tests/ --cov=toolbox --cov-report=xml --cov-report=html --junitxml=test-results.xml || echo "Tests completed with failures"

          # æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
          Write-Host "Test summary:" -ForegroundColor Green
          if (Test-Path test-results.xml) {
            [xml]$testXml = Get-Content test-results.xml
            $tests = $testXml.testsuites.testsuite.tests
            $failures = $testXml.testsuites.testsuite.failures
            $errors = $testXml.testsuites.testsuite.errors
            Write-Host "Tests: $tests, Failures: $failures, Errors: $errors"
          }

      - name: Upload test coverage to Codecov
        if: github.event.inputs.skip_tests != 'true' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      # PyInstalleræ„å»º
      - name: Build with PyInstaller
        run: |
          venv\Scripts\activate

          Write-Host "Starting PyInstaller build..." -ForegroundColor Green

          # ä½¿ç”¨ç°æœ‰çš„specæ–‡ä»¶ï¼Œä½†è¿›è¡Œä¼˜åŒ–
          $specContent = Get-Content main.spec

          # åˆ›å»ºä¼˜åŒ–çš„specæ–‡ä»¶
          $optimizedSpec = @"
          # -*- mode: python ; coding: utf-8 -*-
          # Auto-generated optimized spec for GitHub Actions
          # Build Timestamp: ${{ env.BUILD_TIMESTAMP }}
          # Version: ${{ needs.pre-build.outputs.version_tag }}

          from pathlib import Path
          import sys
          import os

          # ç‰ˆæœ¬ä¿¡æ¯
          version_info = {
              'version': '${{ needs.pre-build.outputs.version_tag }}',
              'description': 'Wuthering Waves Toolbox - Automated echo analysis and management tool',
              'company': 'WW-Toolbox',
              'product': 'WW Toolbox',
              'file_version': '${{ needs.pre-build.outputs.version_tag }}',
              'product_version': '${{ needs.pre-build.outputs.version_tag }}',
          }

          # å¯¼å…¥ä¾èµ–æ¨¡å—ï¼ˆä»åŸå§‹specæ–‡ä»¶ï¼‰
          import rapidocr
          import openvino

          package_name = 'rapidocr'
          install_dir = Path(rapidocr.__file__).resolve().parent
          openvino_dir = Path(openvino.__file__).resolve().parent

          # æ”¶é›†æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶ï¼ˆä¿æŒåŸå§‹é€»è¾‘ï¼‰
          onnx_paths = list(install_dir.rglob('*.onnx'))
          dll_paths = list(openvino_dir.rglob('*.dll'))
          yaml_paths = list(install_dir.rglob('*.yaml'))

          onnx_add_data = [(str(v.parent), f'{package_name}/{v.parent.name}')
                           for v in onnx_paths]

          yaml_add_data = []
          dll_add_data = []

          for v in dll_paths:
              if 'openvino' == v.parent.name:
                  dll_add_data.append((str(v.parent / '*.dll'), 'openvino'))
              else:
                  dll_add_data.append(
                      (str(v.parent / '*.dll'), f'openvino/{v.parent.name}'))

          for v in yaml_paths:
              if package_name == v.parent.name:
                  yaml_add_data.append((str(v.parent / '*.yaml'), package_name))
              else:
                  yaml_add_data.append(
                      (str(v.parent / '*.yaml'), f'{package_name}/{v.parent.name}'))

          add_data = list(set(yaml_add_data + onnx_add_data + dll_add_data))

          # PyInstalleråˆ†æï¼ˆä¼˜åŒ–é…ç½®ï¼‰
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=add_data,
              hiddenimports=[
                  'toolbox.core.profile_cpp',
                  'toolbox.utils.ocr',
                  'toolbox.utils.logger',
                  'PIL._tkinter_finder',
                  'pywin32',
                  'win32gui',
                  'win32api',
                  'win32con',
                  'ctypes.wintypes'
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=['matplotlib', 'scipy', 'pandas', 'jupyter', 'notebook'],
              noarchive=False,
              optimize=2,
          )

          pyz = PYZ(a.pure)

          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='main',
              debug=False,
              bootloader_ignore_signals=False,
              strip=True,
              upx=True,
              console=True,  # ä¿æŒæ§åˆ¶å°è¾“å‡ºä»¥ä¾¿è°ƒè¯•
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )

          coll = COLLECT(
              exe,
              a.binaries,
              a.datas,
              strip=False,
              upx=True,
              upx_exclude=[],
              name='main',
          )
          "@

          $optimizedSpec | Out-File -FilePath main-optimized.spec -Encoding utf8
          Write-Host "Optimized spec file created"

          # æ‰§è¡ŒPyInstalleræ„å»º
          pyinstaller main-optimized.spec --clean --noconfirm

          Write-Host "PyInstaller build completed" -ForegroundColor Green

          # æ£€æŸ¥æ„å»ºç»“æœ
          if (Test-Path "dist/main/main.exe") {
            $exeSize = (Get-Item "dist/main/main.exe").Length / 1MB
            Write-Host "EXE size: $exeSize MB" -ForegroundColor Green
          } else {
            Write-Error "Build failed: main.exe not found"
            exit 1
          }

      - name: Verify build integrity
        run: |
          # æ£€æŸ¥EXEæ–‡ä»¶å®Œæ•´æ€§
          if (-not (Test-Path "dist/main/main.exe")) {
            Write-Error "Build verification failed: EXE not found"
            exit 1
          }

          # è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
          $sha256 = Get-FileHash "dist/main/main.exe" -Algorithm SHA256
          echo "SHA256=$($sha256.Hash)" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "EXE SHA256: $($sha256.Hash)" -ForegroundColor Green

          # æ£€æŸ¥ä¾èµ–æ–‡ä»¶
          $requiredFiles = @(
            "dist/main/main.exe",
            "dist/main"
          )

          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              Write-Warning "Warning: $file not found"
            }
          }

          # åˆ›å»ºéªŒè¯æŠ¥å‘Š
          $verificationReport = @{
            build_time = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
            python_version = "${{ matrix.python-version }}"
            platform = "${{ matrix.platform }}"
            version = "${{ needs.pre-build.outputs.version_tag }}"
            exe_path = "dist/main/main.exe"
            exe_size_mb = "{0:N2}" -f ((Get-Item "dist/main/main.exe").Length / 1MB)
            sha256_hash = $sha256.Hash
            build_success = $true
          }

          $verificationReport | ConvertTo-Json -Depth 10 | Out-File -FilePath build-verification.json -Encoding utf8

      # åŠŸèƒ½æ€§æµ‹è¯•
      - name: Run functional tests
        run: |
          Write-Host "Running functional tests..." -ForegroundColor Green

          # æµ‹è¯•EXEåŸºæœ¬å¯åŠ¨ï¼ˆä½¿ç”¨--helpå‚æ•°ï¼‰
          try {
            Start-Process -FilePath "dist/main/main.exe" -ArgumentList "--help" -Wait -PassThru -NoNewWindow -TimeoutSec 30
            Write-Host "EXE help command executed successfully" -ForegroundColor Green
          } catch {
            Write-Warning "EXE help test failed: $($_.Exception.Message)"
          }

          # æ£€æŸ¥ä¾èµ–åº“
          if (Test-Path "dist/main") {
            Write-Host "Build directory found" -ForegroundColor Green

            # æ£€æŸ¥å…³é”®ä¾èµ–æ–‡ä»¶
            $criticalDeps = @("rapidocr", "openvino", "PIL")
            foreach ($dep in $criticalDeps) {
              $found = $false
              Get-ChildItem -Path "dist/main" -Recurse -Filter "*$dep*" | ForEach-Object {
                $found = $true
                Write-Host "Found $dep dependency: $($_.FullName)"
              }
              if (-not $found) {
                Write-Warning "Warning: $dep dependency not found"
              }
            }
          }

      - name: Set artifact information
        id: artifact
        run: |
          $artifactName = "${{ env.ARTIFACT_NAME }}"
          $exePath = "dist/main/main.exe"

          echo "artifact_name=$artifactName" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "exe_path=$exePath" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Artifact name: $artifactName"

      # åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release package
        run: |
          # åˆ›å»ºä¸´æ—¶å‘å¸ƒç›®å½•
          $releaseDir = "${{ env.ARTIFACT_NAME }}"
          New-Item -ItemType Directory -Force -Path $releaseDir

          # å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶
          Copy-Item -Recurse -Force "dist/main/*" "$releaseDir/"

          # åˆ›å»ºæ–‡æ¡£å’Œè¯´æ˜æ–‡ä»¶
          @"
          # Wuthering Waves Toolbox

          Version: ${{ needs.pre-build.outputs.version_tag }}
          Build: ${{ needs.pre-build.outputs.build_number }}
          Python: ${{ matrix.python-version }}
          Platform: Windows x64

          ## ä½¿ç”¨è¯´æ˜

          1. åŒå‡» `main.exe` å¯åŠ¨ç¨‹åº
          2. ç¡®ä¿ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œï¼ˆç”¨äºæ¸¸æˆæˆªå›¾ï¼‰
          3. ç¨‹åºé»˜è®¤ç›‘å¬ http://127.0.0.1:8000
          4. å‰ç«¯ç•Œé¢å°†è‡ªåŠ¨åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€

          ## ç³»ç»Ÿè¦æ±‚

          - Windows 10/11 x64
          - è‡³å°‘ 4GB å¯ç”¨å†…å­˜
          - DirectX 11 æˆ–æ›´é«˜ç‰ˆæœ¬

          ## æ³¨æ„äº‹é¡¹

          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´åŠ è½½æ¨¡å‹
          - ç¡®ä¿æ¸¸æˆåœ¨ 1920x1080 åˆ†è¾¨ç‡ä¸‹è¿è¡Œ
          - å»ºè®®å…³é—­å…¶ä»–å¯èƒ½å ç”¨ç³»ç»Ÿèµ„æºçš„ç¨‹åº

          ## æ•…éšœæ’é™¤

          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
          1. æ˜¯å¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ
          2. æ¸¸æˆæ˜¯å¦åœ¨å‰å°è¿è¡Œ
          3. Windows Defender æ˜¯å¦è¯¯æŠ¥

          ---
          æ„å»ºæ—¶é—´: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          æäº¤å“ˆå¸Œ: ${{ github.sha }}
          "@ | Out-File -FilePath "$releaseDir/README.md" -Encoding utf8

          # å¤åˆ¶è®¸å¯è¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "$releaseDir/LICENSE"
          }

          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          @{
            version = "${{ needs.pre-build.outputs.version_tag }}"
            build_number = "${{ needs.pre-build.outputs.build_number }}"
            commit_hash = "${{ github.sha }}"
            branch = "${{ github.ref_name }}"
            python_version = "${{ matrix.python-version }}"
            build_timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
            build_platform = "${{ matrix.platform }}"
            exe_sha256 = "${{ env.SHA256 }}"
          } | ConvertTo-Json -Depth 10 | Out-File -FilePath "$releaseDir/version.json" -Encoding utf8

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.artifact_name }}
          path: ${{ env.ARTIFACT_NAME }}/
          retention-days: 30
          if-no-files-found: error

      - name: Upload diagnostic information
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.artifact_name }}-diagnostics
          path: |
            build-verification.json
            bandit-report.json
            safety-report.json
            test-results.xml
            coverage.xml
            main-optimized.spec
          retention-days: 7
          if-no-files-found: ignore

  # å‘å¸ƒç®¡ç†
  release:
    name: Create Release
    needs: [pre-build, build]
    runs-on: windows-latest
    if: needs.pre-build.outputs.should_publish == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create changelog
        id: changelog
        run: |
          $changelogContent = @"
          # æ›´æ–°æ—¥å¿—

          ## ç‰ˆæœ¬ ${{ needs.pre-build.outputs.version_tag }}

          ### æ–°åŠŸèƒ½
          - è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹ä¼˜åŒ–
          - å¢å¼ºçš„ä¾èµ–ç®¡ç†å’Œç¼“å­˜
          - å®Œæ•´çš„æµ‹è¯•è¦†ç›–å’Œè´¨é‡æ£€æŸ¥

          ### æŠ€æœ¯æ”¹è¿›
          - æ”¯æŒå¤šPythonç‰ˆæœ¬æ„å»ºçŸ©é˜µ
          - UPXå‹ç¼©ä¼˜åŒ–æ–‡ä»¶å¤§å°
          - å®‰å…¨æ¼æ´æ‰«æå’Œä¾èµ–æ£€æŸ¥
          - è¯¦ç»†çš„æ„å»ºè¯Šæ–­å’Œæ—¥å¿—è®°å½•

          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 x64
          - 4GB+ å†…å­˜
          - ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºæ¸¸æˆäº¤äº’ï¼‰

          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ `main.exe`
          4. æµè§ˆå™¨å°†è‡ªåŠ¨æ‰“å¼€ç®¡ç†ç•Œé¢

          ### å·²çŸ¥é—®é¢˜
          - Windows Defenderå¯èƒ½è¯¯æŠ¥ï¼Œè¯·æ·»åŠ ä¿¡ä»»
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´åŠ è½½æ¨¡å‹

          ---
          æ„å»ºä¿¡æ¯ï¼š
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æ„å»ºæ—¶é—´: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          "@

          $changelogContent | Out-File -FilePath "CHANGELOG.md" -Encoding utf8
          echo "changelog_created=true" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Changelog created successfully"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.pre-build.outputs.version_tag }}
          name: WW Toolbox v${{ needs.pre-build.outputs.version_tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ github.ref_type != 'tag' }}
          files: |
            artifacts/**/*.exe
            artifacts/**/README.md
            artifacts/**/version.json
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºæ€»ç»“å’Œé€šçŸ¥
  build-summary:
    name: Build Summary
    needs: [pre-build, build, release]
    runs-on: windows-latest
    if: always()

    steps:
      - name: Build Success Summary
        if: needs.build.result == 'success'
        run: |
          Write-Host "ğŸ‰ Build completed successfully!" -ForegroundColor Green
          Write-Host "" -ForegroundColor Green
          Write-Host "Build Information:" -ForegroundColor Cyan
          Write-Host "  â€¢ Version: ${{ needs.pre-build.outputs.version_tag }}" -ForegroundColor White
          Write-Host "  â€¢ Build Number: ${{ needs.pre-build.outputs.build_number }}" -ForegroundColor White
          Write-Host "  â€¢ Commit: ${{ github.sha }}" -ForegroundColor White
          Write-Host "  â€¢ Branch: ${{ github.ref_name }}" -ForegroundColor White
          Write-Host "" -ForegroundColor Green
          Write-Host "Artifacts:" -ForegroundColor Cyan
          Write-Host "  â€¢ Windows EXE builds created" -ForegroundColor White
          Write-Host "  â€¢ Test coverage reports generated" -ForegroundColor White
          Write-Host "  â€¢ Security scans completed" -ForegroundColor White

          if ('${{ needs.release.result }}' -eq 'success') {
            Write-Host "" -ForegroundColor Green
            Write-Host "ğŸš€ Release created successfully!" -ForegroundColor Yellow
          }

      - name: Build Failure Summary
        if: needs.build.result == 'failure'
        run: |
          Write-Host "âŒ Build failed!" -ForegroundColor Red
          Write-Host "" -ForegroundColor Red
          Write-Host "Failed Job Information:" -ForegroundColor Yellow
          Write-Host "  â€¢ Version: ${{ needs.pre-build.outputs.version_tag }}" -ForegroundColor White
          Write-Host "  â€¢ Commit: ${{ github.sha }}" -ForegroundColor White
          Write-Host "  â€¢ Branch: ${{ github.ref_name }}" -ForegroundColor White
          Write-Host "" -ForegroundColor Red
          Write-Host "Please check:" -ForegroundColor Yellow
          Write-Host "  â€¢ Workflow logs for detailed error information" -ForegroundColor White
          Write-Host "  â€¢ Downloaded diagnostic artifacts" -ForegroundColor White
          Write-Host "  â€¢ Requirements.txt compatibility" -ForegroundColor White