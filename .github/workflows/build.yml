name: Build Windows EXE

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\pip\Cache
            ~\AppData\Local\pypoetry
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'setup.py', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            frontend\node_modules
            ~\AppData\Local\npm-cache
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('frontend/package-lock.json', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Configure MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Initialize MSVC environment and install dependencies
        run: |
          # === å…³é”®ï¼šè®¾ç½® DISTUTILS_USE_SDK ç¯å¢ƒå˜é‡ ===
          # è¿™å‘Šè¯‰ distutils ä½¿ç”¨å·²å®‰è£…çš„ MSVC è€Œä¸éœ€è¦ vcvarsall
          $env:DISTUTILS_USE_SDK = "1"
          $env:PY_VCRUNTIME_REDIST = "no"

          # æŸ¥æ‰¾ vcvarsall.bat å¹¶è®¾ç½® INCLUDE å’Œ LIB ç¯å¢ƒå˜é‡
          Write-Host "=== MSVC ç¯å¢ƒåˆå§‹åŒ– ===" -ForegroundColor Cyan

          $vcPaths = @(
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
          )

          $vcInstallDir = $null
          foreach ($path in $vcPaths) {
            if (Test-Path $path) {
              Write-Host "æ‰¾åˆ° vcvarsall.bat: $path" -ForegroundColor Green
              $vcInstallDir = Split-Path -Path $path -Parent
              break
            }
          }

          if ($vcInstallDir) {
            # æ‰‹åŠ¨è®¾ç½® INCLUDE ç¯å¢ƒå˜é‡ï¼ˆç”¨äºç¼–è¯‘ï¼‰
            $includePaths = @(
              "$vcInstallDir\ATLMFC\include",
              "$vcInstallDir\include",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\ucrt",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um",
              "C:\Program Files (x86)\Windows Kits\NETFXSDK\4.8\Include\um"
            )

            # æ‰‹åŠ¨è®¾ç½® LIB ç¯å¢ƒå˜é‡ï¼ˆç”¨äºé“¾æ¥ï¼‰
            $libPaths = @(
              "$vcInstallDir\ATLMFC\lib\x64",
              "$vcInstallDir\lib\x64",
              "C:\Program Files (x86)\Windows Kits\10\lib\10.0.22621.0\ucrt\x64",
              "C:\Program Files (x86)\Windows Kits\10\lib\10.0.22621.0\um\x64"
            )

            # ç»„åˆè·¯å¾„
            $env:INCLUDE = $includePaths -join ";"
            $env:LIB = $libPaths -join ";"
            $env:LIBPATH = "$vcInstallDir\lib\x64;$vcInstallDir\ATLMFC\lib\x64"

            Write-Host "âœ“ MSVC ç¯å¢ƒå˜é‡å·²è®¾ç½®" -ForegroundColor Green
            Write-Host "INCLUDE è·¯å¾„æ•°é‡: $(($env:INCLUDE -split ';').Count)" -ForegroundColor Gray
            Write-Host "LIB è·¯å¾„æ•°é‡: $(($env:LIB -split ';').Count)" -ForegroundColor Gray
          } else {
            Write-Host "è­¦å‘Š: æœªæ‰¾åˆ° vcvarsall.batï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿé»˜è®¤è®¾ç½®" -ForegroundColor Yellow
          }

          # === å®‰è£… Python ä¾èµ– ===
          Write-Host "`n=== å®‰è£… Python ä¾èµ– ===" -ForegroundColor Cyan
          python -m pip install --upgrade pip setuptools wheel

          # å®‰è£…é¡¹ç›®ä¾èµ–
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }

          # å®‰è£… PyInstaller å’Œå¼€å‘ä¾èµ–
          pip install pyinstaller pytest

          # âš ï¸ å…³é”®ï¼šå°† pybind11 å’Œé¡¹ç›®å®‰è£…åˆå¹¶ä¸ºå•ä¸ªå‘½ä»¤
          # é¿å…å­è¿›ç¨‹æ‰¾ä¸åˆ° pybind11 çš„é—®é¢˜
          pip install pybind11 -e .

          Write-Host "=== ä¾èµ–å®‰è£…å®Œæˆ ===" -ForegroundColor Green

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          # å®‰è£… npm ä¾èµ–
          npm ci

          # æ³¨æ„ï¼šæ­¤é¡¹ç›®ä½¿ç”¨ Electronï¼Œæ— éœ€å‰ç«¯æ„å»ºæ­¥éª¤
          # å‰ç«¯æ–‡ä»¶å°†ç›´æ¥åŒ…å«åœ¨ PyInstaller æ„å»ºä¸­

      - name: Verify C++ extension compilation
        run: |
          python -c "import profile_cpp; print('C++ extension loaded successfully')"
          python -c "import toolbox.core.api; print('Backend modules loaded successfully')"

      - name: Run backend tests
        run: |
          python -m pytest toolbox/ -v --tb=short || echo "Tests completed with status: $?"

      - name: Build executable with PyInstaller
        run: |
          # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
          if (Test-Path "dist") { Remove-Item -Recurse -Force dist }
          if (Test-Path "build") { Remove-Item -Recurse -Force build }

          # ä½¿ç”¨ PyInstaller æ„å»º
          pyinstaller main.spec --clean --noconfirm

      - name: Verify executable build
        run: |
          # æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "dist")) {
            Write-Error "dist directory not found after PyInstaller build"
            exit 1
          }

          # æ£€æŸ¥ä¸»å¯æ‰§è¡Œæ–‡ä»¶
          $exePath = "dist\main\main.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "Executable not found at $exePath"
            exit 1
          }

          # è·å–å¯æ‰§è¡Œæ–‡ä»¶å¤§å°
          $exeSize = (Get-Item $exePath).Length / 1MB
          Write-Host "Executable size: $([math]::Round($exeSize, 2)) MB"

          if ($exeSize -lt 1) {
            Write-Error "Executable seems too small ($exeSize MB), possible build failure"
            exit 1
          }

          Write-Host "Executable built successfully: $exePath"

      - name: Scan executable with security tools
        run: |
          # å®‰è£…å¹¶è¿è¡Œå®‰å…¨æ‰«æå·¥å…·
          pip install bandit

          # ä»£ç å®‰å…¨æ‰«æ
          bandit -r toolbox/ -f json -o bandit-report.json || true

          Write-Host "Security scan completed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe-${{ matrix.python-version }}
          path: |
            dist/
            *.log
            bandit-report.json
          retention-days: 30

      - name: Generate build summary
        if: always()
        run: |
          $summary = @"
          ## æ„å»ºæ‘˜è¦ - Python ${{ matrix.python-version }}

          ### æ„å»ºç»“æœ
          - **çŠ¶æ€**: ${{ job.status }}
          - **æ“ä½œç³»ç»Ÿ**: ${{ runner.os }}
          - **Python ç‰ˆæœ¬**: ${{ matrix.python-version }}
          - **Node.js ç‰ˆæœ¬**: ${{ env.NODE_VERSION }}

          ### æ„å»ºè¯¦æƒ…
          - **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - **æäº¤ SHA**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}

          ### éªŒè¯æ£€æŸ¥
          - âœ… Python ç¯å¢ƒè®¾ç½®
          - âœ… Node.js ç¯å¢ƒè®¾ç½®
          - âœ… ä¾èµ–å®‰è£…
          - âœ… C++ æ‰©å±•ç¼–è¯‘
          - âœ… å‰ç«¯æ„å»º
          - âœ… PyInstaller æ‰“åŒ…
          - âœ… å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯
          - âœ… å®‰å…¨æ‰«æ

          ### æ„å»ºäº§ç‰©
          - `dist/main/main.exe`: ä¸»å¯æ‰§è¡Œæ–‡ä»¶
          - `dist/`: å®Œæ•´åº”ç”¨ç¨‹åºç›®å½•
          - `bandit-report.json`: å®‰å…¨æ‰«ææŠ¥å‘Š

          ---
          *æ„å»ºå·¥ä½œæµ: ${{ github.workflow }}*
          *GitHub Actions*
          "@

          # å°†æ‘˜è¦å†™å…¥æ–‡ä»¶
          $summary | Out-File -FilePath "build-summary.md" -Encoding UTF8

          Write-Host $summary

      - name: Upload build summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-summary-${{ matrix.python-version }}
          path: build-summary.md

  release:
    name: Create Release
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup MSVC environment and build
        run: |
          # === å…³é”®ï¼šè®¾ç½® DISTUTILS_USE_SDK ç¯å¢ƒå˜é‡ ===
          # è¿™å‘Šè¯‰ distutils ä½¿ç”¨å·²å®‰è£…çš„ MSVC è€Œä¸éœ€è¦ vcvarsall
          $env:DISTUTILS_USE_SDK = "1"
          $env:PY_VCRUNTIME_REDIST = "no"

          # æŸ¥æ‰¾ vcvarsall.bat å¹¶è®¾ç½® INCLUDE å’Œ LIB ç¯å¢ƒå˜é‡
          Write-Host "=== MSVC ç¯å¢ƒåˆå§‹åŒ– ===" -ForegroundColor Cyan

          $vcPaths = @(
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat",
            "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
          )

          $vcInstallDir = $null
          foreach ($path in $vcPaths) {
            if (Test-Path $path) {
              Write-Host "æ‰¾åˆ° vcvarsall.bat: $path" -ForegroundColor Green
              $vcInstallDir = Split-Path -Path $path -Parent
              break
            }
          }

          if ($vcInstallDir) {
            # æ‰‹åŠ¨è®¾ç½® INCLUDE ç¯å¢ƒå˜é‡ï¼ˆç”¨äºç¼–è¯‘ï¼‰
            $includePaths = @(
              "$vcInstallDir\ATLMFC\include",
              "$vcInstallDir\include",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\ucrt",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared",
              "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um",
              "C:\Program Files (x86)\Windows Kits\NETFXSDK\4.8\Include\um"
            )

            # æ‰‹åŠ¨è®¾ç½® LIB ç¯å¢ƒå˜é‡ï¼ˆç”¨äºé“¾æ¥ï¼‰
            $libPaths = @(
              "$vcInstallDir\ATLMFC\lib\x64",
              "$vcInstallDir\lib\x64",
              "C:\Program Files (x86)\Windows Kits\10\lib\10.0.22621.0\ucrt\x64",
              "C:\Program Files (x86)\Windows Kits\10\lib\10.0.22621.0\um\x64"
            )

            # ç»„åˆè·¯å¾„
            $env:INCLUDE = $includePaths -join ";"
            $env:LIB = $libPaths -join ";"
            $env:LIBPATH = "$vcInstallDir\lib\x64;$vcInstallDir\ATLMFC\lib\x64"

            Write-Host "âœ“ MSVC ç¯å¢ƒå˜é‡å·²è®¾ç½®" -ForegroundColor Green
          } else {
            Write-Host "è­¦å‘Š: æœªæ‰¾åˆ° vcvarsall.batï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿé»˜è®¤è®¾ç½®" -ForegroundColor Yellow
          }

          # === æ„å»ºå‘å¸ƒç‰ˆæœ¬ ===
          Write-Host "`n=== æ„å»ºå‘å¸ƒç‰ˆæœ¬ ===" -ForegroundColor Cyan
          # å®‰è£…ä¾èµ–
          python -m pip install --upgrade pip
          pip install pyinstaller

          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          if (Test-Path "dist") { Remove-Item -Recurse -Force dist }
          if (Test-Path "build") { Remove-Item -Recurse -Force build }

          # âš ï¸ å…³é”®ï¼šå°† pybind11 å’Œé¡¹ç›®å®‰è£…åˆå¹¶ä¸ºå•ä¸ªå‘½ä»¤
          # é¿å…å­è¿›ç¨‹æ‰¾ä¸åˆ° pybind11 çš„é—®é¢˜
          pip install pybind11 -e .

          pyinstaller main.spec --clean --noconfirm

      - name: Create distribution archive
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…
          $version = "v1.0.0"
          if ($env:GITHUB_REF -match 'refs/tags/(.+)') {
            $version = $matches[1]
          }

          # å‹ç¼©ä¸º ZIP æ–‡ä»¶
          Compress-Archive -Path "dist\*" -DestinationPath "Wuthering-Waves-Toolbox-$version-Windows.zip" -Force

          # è®¡ç®— SHA256
          $hash = Get-FileHash "Wuthering-Waves-Toolbox-$version-Windows.zip" -Algorithm SHA256
          $hash.Hash | Out-File -FilePath "Wuthering-Waves-Toolbox-$version-Windows.zip.sha256" -Encoding UTF8

          Write-Host "Archive created: Wuthering-Waves-Toolbox-$version-Windows.zip"
          Write-Host "SHA256: $($hash.Hash)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Wuthering Waves Toolbox - ${{ github.ref_name }}"
          body: |
            ## Wuthering Waves Toolbox - Windows Build

            ### æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ github.ref_name }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
            - **GitHub SHA**: `${{ github.sha }}`

            ### ç‰ˆæœ¬ç‰¹æ€§
            - ğŸ—ï¸ åŸºäº Python ${{ env.PYTHON_VERSION }} æ„å»º
            - âš¡ PyInstaller å•æ–‡ä»¶æ‰“åŒ…
            - ğŸ”§ åŒ…å«æ‰€æœ‰å¿…è¦çš„è¿è¡Œæ—¶ä¾èµ–
            - ğŸ›¡ï¸ é€šè¿‡å®‰å…¨æ‰«æ

            ### ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64ä½)
            - æ— éœ€é¢„è£… Python ç¯å¢ƒ
            - ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºæ¸¸æˆçª—å£æ•è·ï¼‰

            ### ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
            2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ `main.exe`
            3. ç¡®ä¿æ¸¸æˆä»¥çª—å£æ¨¡å¼è¿è¡Œ
            4. å¼€å§‹ä½¿ç”¨è‡ªåŠ¨åŒ–åŠŸèƒ½

            ### æ„å»ºäº§ç‰©
            - `main.exe`: ä¸»å¯æ‰§è¡Œæ–‡ä»¶
            - å®Œæ•´åº”ç”¨ç¨‹åºç›®å½•ç»“æ„

            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º*
          files: |
            Wuthering-Waves-Toolbox-*-Windows.zip
            Wuthering-Waves-Toolbox-*-Windows.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: Wuthering-Waves-Toolbox-*-Windows.zip
          asset_name: Wuthering-Waves-Toolbox-Windows.zip
          asset_content_type: application/zip

  cleanup:
    name: Cleanup Build Resources
    needs: [build, release]
    runs-on: windows-latest
    if: always()

    steps:
      - name: Cleanup workflow runs
        run: |
          Write-Host "Build workflow completed"
          Write-Host "Build job status: ${{ needs.build.result }}"
          Write-Host "Release job status: ${{ needs.release.result }}"

          # æ¸…ç†æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if (Test-Path "dist") { Remove-Item -Recurse -Force dist }
          if (Test-Path "build") { Remove-Item -Recurse -Force build }
          if (Test-Path "__pycache__") { Remove-Item -Recurse -Force __pycache__ }
          if (Test-Path "*.egg-info") { Remove-Item -Recurse -Force *.egg-info }

          Write-Host "Cleanup completed"

